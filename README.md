# 안면인식 웹 애플리케이션

## 1. 문제 정의

현대 사회에서 안면인식 기술은 보안, 출입통제, 사용자 인증 등 다양한 분야에서 활용되고 있습니다. 이 프로젝트는 웹 기반 안면인식 시스템을 구현하여 다음과 같은 문제를 해결하고자 합니다:

- 사용자 등록 및 인식을 위한 간편한 인터페이스 부재
- 웹 환경에서 실시간 안면인식 처리의 기술적 어려움
- 다양한 디바이스(데스크톱, 모바일)에서의 일관된 사용자 경험 제공
- 저비용으로 구현 가능한 안면인식 솔루션의 필요성

## 2. 요구사항 분석

### 기능적 요구사항
1. **사용자 등록 기능**
   - 사용자 이름과 얼굴 정보 등록
   - 중복 등록 방지 및 검증
   
2. **안면인식 기능**
   - 실시간 카메라 스트림에서 얼굴 감지
   - 등록된 사용자와 매칭 및 신뢰도 표시
   
3. **사용자 인터페이스**
   - 직관적이고 반응형 웹 디자인
   - 모바일/데스크톱 호환성
   - 카메라 제어(전/후면 전환)
   
4. **결과 표시**
   - 인식된 얼굴에 바운딩 박스 표시
   - 이름 및 신뢰도 정보 제공

### 비기능적 요구사항
1. **성능**
   - 실시간 처리 및 응답 속도
   - 다양한 조명 환경에서의 인식률
   
2. **보안**
   - 안전한 얼굴 데이터 저장
   - 사용자 프라이버시 보호
   
3. **확장성**
   - 다수의 사용자 등록 지원
   - 추가 기능 구현 용이성

## 3. 기술 스택 및 아키텍처

### 기술 스택
- **프론트엔드**: 
  - React (JSX via Babel)
  - HTML5/CSS3
  - 웹 카메라 API
  
- **백엔드**: 
  - Python Flask
  - Flask-CORS (교차 출처 리소스 공유)
  
- **안면인식 처리**:
  - MediaPipe 라이브러리
  - OpenCV (컴퓨터 비전 처리)
  - NumPy (수치 연산)
  
- **배포 및 접근성**:
  - ngrok (터널링 서비스)

### 시스템 아키텍처

```
[사용자 브라우저] <---> [ngrok 터널] <---> [Flask 서버] 
      |                                        |
 [웹캠 접근]                           [MediaPipe + OpenCV]
      |                                        |
 [React UI]                             [파일 시스템 저장]
```

- **클라이언트-서버 모델**: 브라우저에서 React를 통해 UI 렌더링, 서버에서 안면인식 처리
- **RESTful API**: 등록(/register)과 인식(/recognize) 엔드포인트 제공
- **Base64 인코딩**: 이미지 데이터의 클라이언트-서버 전송을 위한 직렬화
- **JSON 기반 통신**: 클라이언트-서버 간 데이터 교환 형식

## 4. 핵심 알고리즘 및 처리 메커니즘

### 안면 감지 및 특징 추출
1. **MediaPipe Face Detection**:
   - 입력 이미지에서 얼굴 영역 감지
   - 바운딩 박스 좌표 추출 (xmin, ymin, width, height)

2. **MediaPipe Face Mesh**:
   - 감지된 얼굴 영역에서 상세 랜드마크 추출
   - 3D 랜드마크 좌표(x, y, z)를 특징 벡터로 변환

### 얼굴 매칭 알고리즘
1. **유클리드 거리 기반 유사도 계산**:
   ```python
   def calculate_similarity(features1, features2):
       distance = np.linalg.norm(np.array(features1) - np.array(features2))
       similarity = max(0, 1 - distance / 10)
       return similarity
   ```

2. **매칭 프로세스**:
   - 등록 시: 기존 DB와 비교하여 유사도 0.95 이상이면 중복으로 판단
   - 인식 시: 최고 유사도가 0.7 이상인 경우 매칭 성공으로 판단

### 이미지 처리 파이프라인
1. 브라우저에서 캡처된 이미지를 Base64로 인코딩
2. 서버에서 이미지 디코딩 및 NumPy 배열로 변환
3. BGR에서 RGB 색상 공간으로 변환(MediaPipe 요구사항)
4. 얼굴 감지 및 특징 추출
5. 특징 벡터 비교 및 결과 반환

## 5. 구현 과정 및 주요 코드 설명

### 서버 측 구현

#### Flask 애플리케이션 초기화 및 설정
```python
app = Flask(__name__, template_folder='./www', static_folder='./www', static_url_path='/')
CORS(app)  # 교차 출처 리소스 공유 허용
```

#### 이미지 디코딩 함수
```python
def decode_image(image_data):
    image_data = image_data.split(',')[1]  # Base64 데이터 부분 추출
    image_bytes = base64.b64decode(image_data)  # Base64 디코딩
    nparr = np.frombuffer(image_bytes, np.uint8)  # 바이트 → NumPy 배열
    image = cv2.imdecode(nparr, cv2.IMREAD_COLOR)  # 이미지로 디코딩
    return image
```

#### 안면 특징 추출
MediaPipe 라이브러리를 사용하여 얼굴을 감지하고 특징점을 추출합니다. 감지된 얼굴 영역의 바운딩 박스를 계산하고, Face Mesh를 통해 상세 랜드마크를 추출합니다.

#### 등록 API 엔드포인트
```python
@app.route('/register', methods=['POST'])
def register_face():
    # 이미지 디코딩 및 얼굴 특징 추출
    # 유사도 검사로 중복 확인
    # 데이터베이스 저장 (JSON 파일)
    # 결과 반환
```

#### 인식 API 엔드포인트
```python
@app.route('/recognize', methods=['POST'])
def recognize_face():
    # 이미지 디코딩 및 얼굴 특징 추출
    # 데이터베이스의 모든 얼굴과 유사도 계산
    # 최적 매칭 결과 반환
```

### 클라이언트 측 구현

#### React 컴포넌트 구조
```jsx
const FaceRecognitionApp = () => {
    // 상태 관리 (카메라 스트림, 결과 등)
    // 카메라 제어 함수
    // 이미지 캡처 및 API 통신 함수
    // UI 렌더링
}
```

#### 카메라 접근 및 제어
웹 브라우저의 `getUserMedia` API를 사용하여 카메라 스트림에 접근하고, 전/후면 카메라 전환 기능을 구현했습니다.

#### 이미지 캡처 및 서버 통신
Canvas API를 사용하여 비디오 프레임을 캡처하고, Fetch API를 통해 서버에 데이터를 전송합니다.

#### 결과 시각화
Canvas에 바운딩 박스와 식별 정보를 그려 사용자에게 인식 결과를 시각적으로 제공합니다.

## 6. 해결 과정에서 발생한 문제점과 해결 방법

### 1. 모바일 환경에서의 접근성 문제
- **문제**: 로컬 개발 환경에서 모바일 기기로 접근이 어려움
- **해결**: ngrok을 사용하여 로컬 서버를 공개 URL로 터널링하여 모바일 접근성 확보

### 2. 카메라 방향 제어
- **문제**: 모바일에서 전/후면 카메라 전환 시 호환성 이슈
- **해결**: `facingMode` 속성을 사용하여 카메라 방향을 제어하는 크로스 브라우저 솔루션 구현

### 3. 이미지 전송 효율성
- **문제**: 고해상도 이미지 전송 시 성능 저하
- **해결**: Base64 인코딩과 JPEG 압축률 조정으로 데이터 크기 최적화

### 4. 얼굴 매칭 정확도
- **문제**: 조명, 각도 변화에 따른 인식률 저하
- **해결**: 유사도 임계값 조정 및 3D 랜드마크 활용으로 견고성 개선

## 7. 습득한 기술 및 인사이트

1. **웹 기반 컴퓨터 비전 통합**
   - 브라우저 환경에서 컴퓨터 비전 기능 구현의 기술적 세부사항
   - 프론트엔드와 백엔드 간의 효과적인 이미지 데이터 전송 방식

2. **MediaPipe 활용**
   - 경량화된 머신러닝 모델을 웹 서비스에 통합하는 방법
   - 얼굴 랜드마크 추출 및 처리 기술

3. **반응형 UI 설계**
   - 다양한 디바이스에서 일관된 사용자 경험 제공 방법
   - 카메라 컨트롤과 피드백 UI의 효과적인 구성

4. **실시간 데이터 처리**
   - 웹 환경에서 카메라 스트림 처리 최적화
   - 서버-클라이언트 간 비동기 통신 패턴


## 8. 실행 방법

1. 필요한 패키지 설치:
   ```bash
   pip install flask flask-cors mediapipe opencv-python-headless pyngrok numpy
   ```

2. 서버 실행:
   ```bash
   python run_server.py
   ```

3. 제공된 ngrok URL을 통해 애플리케이션 접속

## 9. 프로젝트 구조

```
Facial-recognition-web-application/
│
├── app.py                 # Flask 백엔드 서버
├── run_server.py          # 서버 실행 및 ngrok 터널링 스크립트
├── www/                   # 프론트엔드 파일
│   └── index.html         # React 애플리케이션
│
└── face_data/             # 등록된 얼굴 데이터 저장 디렉토리
```

## 10. 개발 과정의 주요 도전 과제

1. 브라우저 환경에서의 카메라 접근 및 제어
2. 실시간 이미지 처리 및 서버-클라이언트 통신 최적화
3. 다양한 환경(조명, 각도)에서의 안면인식 정확도 향상
4. 모바일 디바이스에서의 사용성 개선

## 11. 결론

이 프로젝트를 통해 웹 기반 안면인식 시스템의 기본 기능을 성공적으로 구현했습니다. 사용자 등록, 얼굴 인식, 그리고 직관적인 UI를 통합하여 다양한 디바이스에서 접근 가능한 솔루션을 개발했습니다. MediaPipe와 Flask의 조합은 경량화된 웹 애플리케이션에서도 효과적인 안면인식 기능을 제공할 수 있음을 확인했습니다.
